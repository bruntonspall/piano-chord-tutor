<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Piano Chords Test</title>
    <style>
.keyboard-block {
  float: left;
}
.keyboard-block h2 {
  width: 400px;
}
    </style>
<script>
  function playableChord(chord, inversion) {
    // Returns ['c', 'e', 'g'] for 'c', ['e', 'g', 'c'] for 'c', 'back'
    var notes = notesForChord(chord, inversion);
    var keys = [
      "c-1", "csharp-1", "d-1", "eflat-1", "e-1", "f-1", "fsharp-1", "g-1", "aflat-1", "a-1", "bflat-1", "b-1",
      "c-2", "csharp-2", "d-2", "eflat-2", "e-2", "f-2", "fsharp-2", "g-2", "aflat-2", "a-2", "bflat-2", "b-2"
      ];
    result = [];
    note = 0;
    // find first instance of first note
    for(var i = 0; i != keys.length; ++i) {
      if (keys[i].substring(0, keys[i].length-2) === notes[note]) {
        result.push(keys[i]);
        note += 1;
        if (note > 3) break;
      }
    }
    return result;
  }

  var notes = [
    "c", "csharp", "d", "eflat", "e", "f", "fsharp", "g", "aflat", "a", "bflat", "b"
    ];

  function notesForChord(chord, inversion) {
    chord = chord.toLowerCase();
    // find root note
    for(var i = 0; i != notes.length; ++i) {
      if (notes[i] === chord) break;
    }
    var intervals = [(i+0),(i+4)%12,(i+7)%12];
    var inversions = {
      "root": [0,1,2],
      "middle": [2,0,1],
      "back": [1,2,0]
    }
    return [notes[intervals[inversions[inversion][0]]], notes[intervals[inversions[inversion][1]]], notes[intervals[inversions[inversion][2]]]];
  }

  function calculateCircle() {
    // Circle of Fifths is all the notes, repeated in 5's
    result = [];
    for (var i = 0; i < 12; ++i) {
      result.push(notes[(i*5)%12]);
    }
    return result;
  }
  var circle = calculateCircle();


  function hideNotes(keyboard) {
    var svgDoc = keyboard.getSVGDocument();
    var el = svgDoc.getElementById("notes");
    var a = el.querySelectorAll('*');
    for (var i = 0; i != a.length; i++) {
      a[i].style.opacity = 0;
    }
  }

  function showNote(keyboard, note) {
    var svgDoc = keyboard.getSVGDocument();
    var el = svgDoc.getElementById("note-"+note);
    if (el) el.style.opacity = 100;
  }

  function showChord(keyboard, chord, inversion) {
    console.log("Playing "+chord+" "+inversion);
    hideNotes(keyboard);
    if (inversion == null) inversion = "root";
    var title = keyboard.parentElement.querySelector("h2");
    if (title) title.innerHTML = chord+" "+inversion;
    var notes = playableChord(chord, inversion);
    for (var i = 0; i != notes.length; i++) {
      showNote(keyboard, notes[i]);
    }
  }

  var currentNote = 0;
  function playNote(keyboard) {
    var nextNote = circle[currentNote];
    showChord(keyboard, nextNote, currentNote % 2 == 0? "root": "middle");
    if (++currentNote == circle.length) currentNote = 0; 
    keyboard.querySelector("#next_chord").innerHTML = "Next: "+circle[currentNote]+" "+(currentNote % 2 == 0? "root": "middle");
  }
  
  var playing = false;
  var g_keyboard = null;

  function startCircle() {
    var btn = document.getElementById("play");
    if (!playing) {
      playing = window.setInterval(function() {playNote(g_keyboard);}, 2500);
      btn.innerHTML = "Stop";
    } else {
      window.clearInterval(playing);
      playing = false;
      currentNote = 0;
      btn.innerHTML = "Play";
    }
  };

  function createKeyboard() {
    var container = document.createElement("div");
    container.classList.add("keyboard-block");
    var header = document.createElement("h2");
    container.appendChild(header);
    var keyboard = document.createElement("object");
    keyboard.type = "image/svg+xml";
    keyboard.data = "keyboard.svg";
    container.appendChild(keyboard);
    return container;
  }

  function showCircle() {
    var placement = document.getElementById("placement");
    for (var i = 0; i != circle.length; ++i) {
      var chord = circle[(i+8)%circle.length];
      var new_kbd_div = createKeyboard();
      var new_kbd = new_kbd_div.querySelector("object")
      new_kbd.id = "chord-"+i;
      (function(_kbd, _chord, _i) {
        new_kbd.addEventListener("load", function() {
          showChord(_kbd, _chord, _i % 2 == 0? "root": "middle"); 
        });
      })(new_kbd, chord, i);
      placement.appendChild(new_kbd_div);
    }
  }


  window.addEventListener("load", function() {
    console.log("Hiding notes");
    g_keyboard = document.getElementById("keyboard");
    hideNotes(g_keyboard);
    showChord(g_keyboard, "e", "root");
    showCircle();
    document.getElementById('start_chord').addEventListener("input", function() {
        var chord = document.getElementById('start_chord').value;
        var inversion = document.getElementById('inversions').value;
        showChord(g_keyboard, chord, inversion);
        });
    document.getElementById('inversions').addEventListener("input", function() {
        var chord = document.getElementById('start_chord').value;
        var inversion = document.getElementById('inversions').value;
        showChord(g_keyboard, chord, inversion);
        });
  }, true);
</script>
  </head>
  <body>
    <h1>Keyboard</h1>
    <h2>C#m</h2>
    <object type="image/svg+xml" data="keyboard.svg" id="keyboard" ></object>
    <form>
      <select id="start_chord">
        <option value="c">C</option> 
        <option value="csharp">Db</option> 
        <option value="d">D</option> 
        <option value="eflat">Eb</option> 
        <option value="e" selected>E</option> 
        <option value="f">F</option> 
        <option value="fsharp">F#</option> 
        <option value="g">G</option> 
        <option value="aflat">Ab</option> 
        <option value="a">A</option> 
        <option value="bflat">Bb</option> 
        <option value="b">B</option>
      </select>
      <select id="inversions">
        <option value="root" selected>Root</option>
        <option value="middle">Middle</option>
        <option value="back">Back</option>
      </select>
      <input type=checkbox id="minor" value=minor>Minor Chords</input>
    </form>
    <button onclick="startCircle();" id="play">Play Circle</button>
    <button onclick="displayCircle();" id="display">Display Chords</button>
    <br/>
    <div id="placement"></div>
  </body>
</html>
